import { chromium, Frame } from 'playwright';
import path from 'path';

export async function singleAccountTest(email: string, uid: string, code: string, pass: string) {
    const userDataDir = path.resolve(process.cwd(), 'sessions/main_account');

    const context = await chromium.launchPersistentContext(userDataDir, {
        headless: false,
        viewport: { width: 1280, height: 720 },
        args: ['--disable-blink-features=AutomationControlled', '--no-sandbox']
    });

    const page = context.pages()[0] || await context.newPage();

    try {
        console.log(`[${email}] üåê –û—Ç–∫—Ä—ã–≤–∞—é Midasbuy...`);
        await page.goto('https://www.midasbuy.com/midasbuy/ru/redeem/pubgm', {
            waitUntil: 'domcontentloaded',
            timeout: 60000
        });

        await page.waitForTimeout(4000);

        // --- –≠–¢–ê–ü 1: –†–ê–°–ß–ò–°–¢–ö–ê ---
        await page.evaluate(() => {
            const selectors = ['.cumulativeRecharge-content_32axf', '.loading-container', '.pagedoo-loading', '.vip-entry-banner', '.PopUp'];
            selectors.forEach(s => {
                const el = document.querySelector(s) as HTMLElement;
                if (el) el.style.display = 'none';
            });
        });

        // --- –≠–¢–ê–ü 2: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ---
        const loginBtn = page.locator('text="–í–æ–π—Ç–∏"').or(page.locator('text="Log in"')).first();
        const needsLogin = await loginBtn.isVisible();

        if (needsLogin) {
            console.log(`[!] –í–∏–∂—É –∫–Ω–æ–ø–∫—É "–í–æ–π—Ç–∏". –ù–∞—á–∏–Ω–∞—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...`);
            await loginBtn.click({ force: true });

            // –ú–µ–Ω—é
            const menuLoginBtn = page.locator('div, button').filter({ hasText: /^Login\/Register$/i }).first();
            await menuLoginBtn.waitFor({ state: 'visible', timeout: 5000 });
            await menuLoginBtn.click({ force: true });

            console.log(`[‚è≥] –ñ–¥—É —Ñ—Ä–µ–π–º...`);
            await page.waitForTimeout(4000);

            // –ü–æ–∏—Å–∫ —Ñ—Ä–µ–π–º–∞
            let authFrame: Frame | null = null;
            for (let i = 0; i < 5; i++) {
                for (const frame of page.frames()) {
                    if (await frame.locator('.to-other-login').count() > 0 || await frame.locator('input[type="email"]').count() > 0) {
                        authFrame = frame;
                        break;
                    }
                }
                if (authFrame) break;
                await page.waitForTimeout(1000);
            }

            if (authFrame) {
                console.log(`[üéØ] –§—Ä–µ–π–º –Ω–∞–π–¥–µ–Ω.`);
                const otherBtn = authFrame.locator('.to-other-login, .switch-mode').first();
                if (await otherBtn.isVisible()) {
                    await otherBtn.click({ force: true });
                    await page.waitForTimeout(1000);
                }

                console.log(`[‚úâÔ∏è] –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö...`);
                await authFrame.locator('input[type="email"]').fill(email);

                const continueBtn = authFrame.locator('.comfirm-btn, div[class*="btn"]').filter({ hasText: /–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å|Continue/i }).first();

                // Retry click
                for (let attempt = 1; attempt <= 3; attempt++) {
                    await continueBtn.click({ force: true });
                    try {
                        await authFrame.locator('input[type="password"]').waitFor({ state: 'visible', timeout: 3000 });
                        break;
                    } catch {}
                }

                await authFrame.locator('input[type="password"]').fill(pass);
                const loginSubmitBtn = authFrame.locator('.comfirm-btn, div[class*="btn"]').filter({ hasText: /–í—Ö–æ–¥|Log in/i }).first();
                await loginSubmitBtn.click({ force: true });
            }

            console.log(`[‚è≥] –û–∂–∏–¥–∞–Ω–∏–µ –≤—Ö–æ–¥–∞...`);
            await loginBtn.waitFor({ state: 'hidden', timeout: 60000 });
            console.log(`[‚úÖ] –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω.`);
        } else {
            console.log(`[‚ÑπÔ∏è] –£–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.`);
        }

        // --- –≠–¢–ê–ü 3: –ê–ö–¢–ò–í–ê–¶–ò–Ø (–ò–°–ü–†–ê–í–õ–ï–ù–û) ---

        console.log(`[üîé] –ü—Ä–æ–≤–µ—Ä—è—é –ø–æ–ª–µ –≤–≤–æ–¥–∞ ID...`);

        // –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:
        // –ú—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º isVisible() –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞. –ï—Å–ª–∏ –æ–Ω–æ —Å–∫—Ä—ã—Ç–æ - –∑–Ω–∞—á–∏—Ç ID —É–∂–µ –≤–≤–µ–¥–µ–Ω.
        // –ú—ã –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º fill() —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–≤–∏—Ç—å –æ—à–∏–±–∫—É –æ–∂–∏–¥–∞–Ω–∏—è.
        const idInput = page.locator('.input-account');
        const isInputVisible = await idInput.isVisible();

        if (isInputVisible) {
            console.log(`[${email}] üë§ –ü–æ–ª–µ ID –ø—É—Å—Ç–æ–µ. –í–≤–æ–∂—É ID: ${uid}`);
            await idInput.fill(uid);
            await page.locator('div[class*="Button_text"]').filter({ hasText: /^OK$|^–û–ö$/i }).first().click({ force: true });
            await page.waitForTimeout(2000);
        } else {
            console.log(`[‚úÖ] –ü–æ–ª–µ ID —Å–∫—Ä—ã—Ç–æ/–∑–∞–ø–æ–ª–Ω–µ–Ω–æ. –°—á–∏—Ç–∞–µ–º, —á—Ç–æ ID (${uid}) —É–∂–µ –≤–∞–ª–∏–¥–µ–Ω.`);
        }

        console.log(`[${email}] üîë –í–≤–æ–¥ –∫–æ–¥–∞: ${code}`);
        const redeemInput = page.locator('.input-redeem, input[placeholder*="–∫–æ–¥"]');

        // –ñ–¥–µ–º –ø–æ–ª–µ –∫–æ–¥–∞ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        await redeemInput.waitFor({ state: 'visible', timeout: 10000 });
        await redeemInput.fill(code);

        console.log(`[üöÄ] –û—Ç–ø—Ä–∞–≤–∫–∞...`);
        const submitBtn = page.locator('button.btn-confirm, .submit-button, div[class*="Button_text"]').filter({ hasText: /OK|–û–ö|–û—Ç–ø—Ä–∞–≤–∏—Ç—å/i }).last();
        await submitBtn.click({ force: true });

        await page.waitForTimeout(5000);

        // –ß–∏—Ç–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        try {
            const resultMsg = await page.locator('.PopUp .content, .modal-content').innerText();
            console.log(`[üèÅ] –†–µ–∑—É–ª—å—Ç–∞—Ç: ${resultMsg.replace(/\n/g, ' ')}`);
        } catch {
            console.log(`[üèÅ] –ì–æ—Ç–æ–≤–æ (–≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –∑–∞–∫—Ä—ã–ª–æ—Å—å –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ).`);
        }

        await context.close();

    } catch (error: any) {
        console.error(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
        await context.close();
    }
}

singleAccountTest("MidasBuyMy1@hotmail.com", "51397041237", "KP4JUgnq2j43bdG8F5", "Nikitamidas123!");


import { chromium } from 'playwright';
import type { Frame, Page, BrowserContext } from 'playwright';
import path from 'path';
import fs from 'fs';

export type ActivationResult = 'SUCCESS' | 'CAPTCHA' | 'ERROR' | 'ALREADY_REDEEMED';

const STEALTH_ARGS = [
    '--disable-blink-features=AutomationControlled',
    '--no-sandbox',
    '--disable-setuid-sandbox',
    '--disable-dev-shm-usage',
    '--disable-gpu'
];

/**
 * –û—á–∏—Å—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç –±–∞–Ω–Ω–µ—Ä–æ–≤ –∏ –º–∞—Å–æ–∫
 */
async function applyNuclearCleanup(page: Page) {
    await page.addInitScript(() => {
        const style = document.createElement('style');
        style.innerHTML = `
            [class*="cumulativeRecharge"], [class*="PopUp"], .PopUp,
            [class*="modal-mask"], [class*="mask"], .v-modal,
            .cookie-confirm, .cookie-policy, .pagedoo-loading,
            #fix-bottom-bar, .home-pop {
                display: none !important;
                visibility: hidden !important;
                pointer-events: none !important;
            }
            body, html { overflow: auto !important; pointer-events: auto !important; position: static !important; }
        `;
        document.documentElement.appendChild(style);

        setInterval(() => {
            const closeBtn = document.querySelector('.cumulativeRecharge-close_1TD7P');
            if (closeBtn) (closeBtn as HTMLElement).click();
            document.body.classList.remove('modal-open');
        }, 500);
    });
}

/**
 * –§–£–ù–ö–¶–ò–Ø 1: –ü–†–û–í–ï–†–ö–ê UID
 */
export async function verifyIdOnMidas(uid: string): Promise<{ valid: boolean; nickname?: string }> {
    const browser = await chromium.launch({ headless: false, args: STEALTH_ARGS });
    const page = await browser.newPage();
    await applyNuclearCleanup(page);

    try {
        await page.goto('https://www.midasbuy.com/midasbuy/ru/redeem/pubgm', { waitUntil: 'domcontentloaded', timeout: 30000 });
        const idInput = page.locator('.input-account');
        await idInput.waitFor({ state: 'visible', timeout: 15000 });
        await idInput.fill(uid);
        await page.locator('div[class*="Button_text"]').filter({ hasText: /^OK$|^–û–ö$/i }).first().click({ force: true });

        const nickEl = page.locator('.user-name, .name, .nickname').first();
        await nickEl.waitFor({ state: 'visible', timeout: 10000 });
        const nickname = await nickEl.innerText();
        return { valid: true, nickname: nickname.trim() };
    } catch (e) { return { valid: false }; }
    finally { await browser.close(); }
}

/**
 * –§–£–ù–ö–¶–ò–Ø 2: –ê–ö–¢–ò–í–ê–¶–ò–Ø –ö–û–î–ê
 */
export async function activateSingleCode(account: { email: string, pass: string }, uid: string, code: string): Promise<ActivationResult> {
    const safeEmail = account.email.replace(/[^a-zA-Z0-9]/g, '_');
    const userDataDir = path.resolve(process.cwd(), `sessions/${safeEmail}`);
    if (!fs.existsSync(userDataDir)) fs.mkdirSync(userDataDir, { recursive: true });

    const context = await chromium.launchPersistentContext(userDataDir, {
        headless: false,
        viewport: { width: 1280, height: 720 },
        args: STEALTH_ARGS
    });

    const page = context.pages()[0] || await context.newPage();
    await applyNuclearCleanup(page);
    let result: ActivationResult = 'ERROR';

    try {
        await page.goto('https://www.midasbuy.com/midasbuy/ru/redeem/pubgm', { waitUntil: 'domcontentloaded', timeout: 60000 });

        const loginBtn = page.locator('text="–í–æ–π—Ç–∏"').or(page.locator('text="Log in"')).first();

        if (await loginBtn.isVisible({ timeout: 5000 })) {
            await loginBtn.click({ force: true });
            const menuBtn = page.locator('div, button').filter({ hasText: /^Login\/Register$/i }).first();
            await menuBtn.waitFor({ state: 'visible', timeout: 5000 });

            // --- –õ–û–ì–ò–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò –í–¢–û–†–û–ô –°–¢–†–ê–ù–ò–¶–´ (POPUP) ---
            const [loginPage] = await Promise.all([
                context.waitForEvent('page', { timeout: 10000 }).catch(() => page), // –ñ–¥–µ–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –∏–ª–∏ –æ—Å—Ç–∞–µ–º—Å—è –≤ —Å—Ç–∞—Ä–æ–º
                menuBtn.click({ force: true })
            ]);

            console.log(`[üîê] –†–∞–±–æ—Ç–∞—é –≤ –æ–∫–Ω–µ: ${loginPage.url()}`);

            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞ (–ª–∏–±–æ –≤–æ —Ñ—Ä–µ–π–º–µ, –ª–∏–±–æ –Ω–∞ —Å–∞–º–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ)
            let target: Page | Frame = loginPage;
            const emailInput = loginPage.locator('input[type="email"]');
            const otherBtn = loginPage.locator('.to-other-login, text="–¥—Ä—É–≥–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏"').first();

            // –ï—Å–ª–∏ –ø–æ–ª—è –Ω–µ—Ç —Å—Ä–∞–∑—É, –∏—â–µ–º –≤–æ —Ñ—Ä–µ–π–º–∞—Ö
            if (await emailInput.count() === 0) {
                for (const frame of loginPage.frames()) {
                    if (await frame.locator('input[type="email"]').count() > 0) {
                        target = frame; break;
                    }
                }
            }

            // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –∫–Ω–æ–ø–∫—É "–¥—Ä—É–≥–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏", –∂–º–µ–º
            if (await target.locator('.to-other-login').isVisible()) {
                await target.locator('.to-other-login').click();
            }

            await target.locator('input[type="email"]').fill(account.email);
            const contBtn = target.locator('.comfirm-btn').filter({ hasText: /–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å|Continue/i }).first();

            for(let i = 0; i < 3; i++) {
                await contBtn.click({ force: true });
                try {
                    await target.locator('input[type="password"]').waitFor({ state: 'visible', timeout: 4000 });
                    break;
                } catch (e) {}
            }

            await target.locator('input[type="password"]').fill(account.pass);
            await target.locator('.comfirm-btn').filter({ hasText: /–í—Ö–æ–¥|Log in/i }).first().click({ force: true });

            // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª–æ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –æ–Ω–æ –∑–∞–∫—Ä–æ–µ—Ç—Å—è —Å–∞–º–æ. –ï—Å–ª–∏ –Ω–µ—Ç - –∂–¥–µ–º –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏.
            if (loginPage !== page) {
                await loginPage.waitForEvent('close', { timeout: 30000 }).catch(() => loginPage.close());
            } else {
                await loginBtn.waitFor({ state: 'hidden', timeout: 30000 });
            }
        }

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        await page.bringToFront();
        await page.waitForTimeout(2000);

        const idInput = page.locator('.input-account');
        const isNickVisible = await page.locator('.user-name, .name, .nickname').first().isVisible();

        if (!isNickVisible && await idInput.isVisible()) {
            await idInput.fill(uid);
            await page.locator('div[class*="Button_text"]').filter({ hasText: /^OK$|^–û–ö$/i }).first().click({ force: true });
            await page.waitForTimeout(2000);
        }

        await page.locator('.input-redeem').fill(code);
        await page.locator('button.btn-confirm, .submit-button, div[class*="Button_text"]').filter({ hasText: /OK|–û–ö|–û—Ç–ø—Ä–∞–≤–∏—Ç—å/i }).last().click({ force: true });

        const popup = page.locator('.PopUp .content, .modal-content, .result-title').first();
        await popup.waitFor({ state: 'visible', timeout: 15000 });
        const text = await popup.innerText();

        if (text.includes("Busy") || text.includes("busy")) result = 'CAPTCHA';
        else if (text.includes("Success") || text.includes("–£—Å–ø–µ—à–Ω–æ")) result = 'SUCCESS';
        else if (text.includes("already") || text.includes("–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω")) result = 'ALREADY_REDEEMED';
        else result = 'ERROR';

    } catch (error: any) {
        console.error("–û—à–∏–±–∫–∞:", error.message);
        result = 'CAPTCHA'; // –í –ª—é–±–æ–π –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ (—Ç–∞–π–º–∞—É—Ç) —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –≤—ã–ª–µ–∑–ª–∞ –∫–∞–ø—á–∞
    } finally {
        await context.close();
    }
    return result;
}























import { chromium } from 'playwright';
import type { Frame, Page } from 'playwright';
import path from 'path';
import fs from 'fs';

export type ActivationResult = 'SUCCESS' | 'CAPTCHA' | 'ERROR' | 'ALREADY_REDEEMED';

const STEALTH_ARGS = [
    '--disable-blink-features=AutomationControlled',
    '--no-sandbox',
    '--disable-setuid-sandbox',
    '--disable-dev-shm-usage',
    '--disable-gpu',
    '--window-position=0,0'
];

// –î–æ–±–∞–≤–ª—è–µ–º User-Agent, —á—Ç–æ–±—ã —Å–∞–π—Ç –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –Ω–∞—Å
const USER_AGENT = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36';

/**
 * –û—á–∏—Å—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç –±–∞–Ω–Ω–µ—Ä–æ–≤ –∏ –º–∞—Å–æ–∫
 */
async function applyNuclearCleanup(page: Page) {
    await page.addInitScript(() => {
        const style = document.createElement('style');
        style.innerHTML = `
            [class*="cumulativeRecharge"], [class*="PopUp"], .PopUp,
            [class*="modal-mask"], [class*="mask"], .v-modal,
            .cookie-confirm, .cookie-policy, .pagedoo-loading,
            #fix-bottom-bar, .home-pop {
                display: none !important;
                visibility: hidden !important;
                pointer-events: none !important;
            }
            body, html { overflow: auto !important; pointer-events: auto !important; position: static !important; }
        `;
        document.documentElement.appendChild(style);


        const observer = new MutationObserver(() => {
            const closeBtn = document.querySelector('.cumulativeRecharge-close_1TD7P');
            if (closeBtn) (closeBtn as HTMLElement).click();
            if (document.body.classList.contains('modal-open')) {
                document.body.classList.remove('modal-open');
            }
        });
        observer.observe(document.body, { childList: true, subtree: true });
    });
}

/**
 * –§–£–ù–ö–¶–ò–Ø 1: –ü–†–û–í–ï–†–ö–ê UID
 */
export async function verifyIdOnMidas(uid: string): Promise<{ valid: boolean; nickname?: string }> {
    const browser = await chromium.launch({ headless: false, args: STEALTH_ARGS });
    const context = await browser.newContext({ userAgent: USER_AGENT });
    const page = await context.newPage();
    await applyNuclearCleanup(page);

    try {
        await page.goto('https://www.midasbuy.com/midasbuy/ru/redeem/pubgm', { waitUntil: 'domcontentloaded', timeout: 30000 });
        const idInput = page.locator('.input-account');
        await idInput.waitFor({ state: 'visible', timeout: 15000 });
        await idInput.fill(uid);
        await page.locator('div[class*="Button_text"]').filter({ hasText: /^OK$|^–û–ö$/i }).first().click({ force: true });

        const nickEl = page.locator('.user-name, .name, .nickname').first();
        await nickEl.waitFor({ state: 'visible', timeout: 10000 });
        const nickname = await nickEl.innerText();
        return { valid: true, nickname: nickname.trim() };
    } catch (e) { return { valid: false }; }
    finally { await browser.close(); }
}

/**
 * –§–£–ù–ö–¶–ò–Ø 2: –ê–ö–¢–ò–í–ê–¶–ò–Ø –ö–û–î–ê
 */
export async function activateSingleCode(account: { email: string, pass: string }, uid: string, code: string): Promise<ActivationResult> {
    const safeEmail = account.email.replace(/[^a-zA-Z0-9]/g, '_');
    const userDataDir = path.resolve(process.cwd(), `sessions/${safeEmail}`);
    if (!fs.existsSync(userDataDir)) fs.mkdirSync(userDataDir, { recursive: true });

    const context = await chromium.launchPersistentContext(userDataDir, {
        headless: false,
        viewport: { width: 1280, height: 720 },
        args: STEALTH_ARGS,
        userAgent: USER_AGENT
    });

    const page = context.pages()[0] || await context.newPage();
    await applyNuclearCleanup(page);
    let result: ActivationResult = 'ERROR';

    async function closeMidasBanner(page: Page) {
    const closeBtn = page.locator('.cumulativeRecharge-close_1TD7P');

    try {
        // –ñ–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –º–∞–∫—Å–∏–º—É–º 2 —Å–µ–∫—É–Ω–¥—ã, —á—Ç–æ–±—ã –Ω–µ —Ç–æ—Ä–º–æ–∑–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥
        if (await closeBtn.isVisible({ timeout: 2000 })) {
            console.log("[üßπ] –û–±–Ω–∞—Ä—É–∂–µ–Ω —Ä–µ–∫–ª–∞–º–Ω—ã–π –±–∞–Ω–Ω–µ—Ä, –∑–∞–∫—Ä—ã–≤–∞—é...");
            await closeBtn.click({ force: true });
        }
    } catch (e) {
        // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∏ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∞ –Ω–µ –ø–æ—è–≤–∏–ª–∞—Å—å ‚Äî –ø—Ä–æ—Å—Ç–æ –∏–¥–µ–º –¥–∞–ª—å—à–µ
    }
}

    try {
        console.log(`[üåê] –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ Midasbuy...`);
        await page.goto('https://www.midasbuy.com/midasbuy/ru/redeem/pubgm', { waitUntil: 'domcontentloaded', timeout: 60000 });

        const loginBtn = page.locator('text="–í–æ–π—Ç–∏"').or(page.locator('text="Log in"')).first();
        const isAlreadyLoggedIn = await page.locator('.avatar-img').count() > 0;

        if (!isAlreadyLoggedIn && await loginBtn.isVisible({ timeout: 5000 })) {
            console.log(`[1Ô∏è‚É£] –ù–∞–∂–∏–º–∞—é "–í–æ–π—Ç–∏"...`);
            await loginBtn.click({ force: true });

            const menuBtn = page.locator('div, button').filter({ hasText: /^Login\/Register$/i }).first();
            await menuBtn.waitFor({ state: 'visible', timeout: 5000 });

            console.log(`[2Ô∏è‚É£] –ù–∞–∂–∏–º–∞—é "Login/Register"...`);
            await menuBtn.click({ force: true });

            // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ, –ø–æ–∫–∞ Midas –∑–∞–≥—Ä—É–∑–∏—Ç —Ñ—Ä–µ–π–º
            await page.waitForTimeout(2000);

            // --- –õ–û–ì–ò–ö–ê –ü–û–ò–°–ö–ê –û–ö–ù–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ---
            let target: Page | Frame = page;
            let isFrame = false;

            // 1. –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º IFRAME –Ω–∞ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ (–Ω–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ)
            const frames = page.frames();
            for (const f of frames) {
                // –ò—â–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—É—é –∫–Ω–æ–ø–∫—É "–¥—Ä—É–≥–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏" –∏–ª–∏ –ø–æ–ª–µ email
                if (await f.locator('.to-other-login').count() > 0 || await f.locator('input[type="email"]').count() > 0) {
                    target = f;
                    isFrame = true;
                    console.log(`[üéØ] –ù–∞–π–¥–µ–Ω iframe –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.`);
                    break;
                }
            }

            // 2. –ï—Å–ª–∏ —Ñ—Ä–µ–π–º –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–∫—Ä—ã–ª–∞—Å—å –ª–∏ –≤–∫–ª–∞–¥–∫–∞ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
            if (!isFrame) {
                 const pages = context.pages();
                 if (pages.length > 1) {
                     target = pages[pages.length - 1]; // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–∫–ª–∞–¥–∫—É
                     console.log(`[‚ö†Ô∏è] –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞, –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å.`);
                 }
            }

            // --- –í–ù–£–¢–†–ò –§–û–†–ú–´ ---

            // –ò—â–µ–º –∏ –∂–º–µ–º "–¥—Ä—É–≥–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏", –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å (–∏—Å–ø—Ä–∞–≤–∏–ª —Å–µ–ª–µ–∫—Ç–æ—Ä!)
            const otherBtn = target.locator('.to-other-login')
                .or(target.locator('text="–¥—Ä—É–≥–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏"'))
                .first();

            if (await otherBtn.isVisible()) {
                console.log(`[üñ±Ô∏è] –ñ–º—É "–¥—Ä—É–≥–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏"...`);
                await otherBtn.click({ force: true });
                await page.waitForTimeout(1000);
            }

            console.log(`[‚úâÔ∏è] –í–≤–æ–¥ –ø–æ—á—Ç—ã...`);
            await target.locator('input[type="email"]').fill(account.email);

            const contBtn = target.locator('.comfirm-btn')
                .filter({ hasText: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' })
                .first();

            // –ö–ª–∏–∫ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" —Å –ø–æ–≤—Ç–æ—Ä–æ–º (–∏–Ω–æ–≥–¥–∞ —Ç—É–ø–∏—Ç)
            for(let i = 0; i < 3; i++) {
                await contBtn.click({ force: true });
                try {
                    await target.locator('input[type="password"]').waitFor({ state: 'visible', timeout: 3000 });
                    break;
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –æ–∂–∏–¥–∞–Ω–∏—è, –ø—Ä–æ–±—É–µ–º –∫–ª–∏–∫–Ω—É—Ç—å –µ—â–µ —Ä–∞–∑
                }
            }

            console.log(`[üîë] –í–≤–æ–¥ –ø–∞—Ä–æ–ª—è...`);
            await target.locator('input[type="password"]').fill(account.pass);

            const loginSubmit = target.locator('.comfirm-btn')
                .filter({hasText : '–í—Ö–æ–¥'})

            await loginSubmit.click({ force: true });

            // –ñ–¥–µ–º –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞
            await page.waitForTimeout(4000);
        }

        // --- –ê–ö–¢–ò–í–ê–¶–ò–Ø –ö–û–î–ê ---
        await page.bringToFront();




        const banner = page.locator('.cumulativeRecharge-close_1TD7P');
        if (await banner.isVisible({ timeout: 1500 }).catch(() => false)) {
        await banner.click({ force: true }).catch(() => {});
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –≤–≤–æ–¥–∏—Ç—å ID
        const idInput = page.locator('.input-account');
        const isNickVisible = await page.locator('.user-name, .name, .nickname').first().isVisible();

        if (!isNickVisible && await idInput.isVisible()) {
            console.log(`[üë§] –í–≤–æ–∂—É ID: ${uid}`);
            await idInput.fill(uid);
            await page.locator('div[class*="Button_text"]').filter({ hasText: /^OK$|^–û–ö$/i }).first().click({ force: true });
            await page.waitForTimeout(2000);
        }

        console.log(`[üéÅ] –í–≤–æ–¥ –∫–æ–¥–∞: ${code}`);
        const redeemInput = page.locator('.input-redeem');
        await redeemInput.waitFor({ state: 'visible', timeout: 10000 });
        await redeemInput.fill(code);

        const submitBtn = page.locator('button.btn-confirm, .submit-button, div[class*="Button_text"]').filter({ hasText: /OK|–û–ö|–û—Ç–ø—Ä–∞–≤–∏—Ç—å/i }).last();
        await submitBtn.click({ force: true });

        // –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        console.log("[‚è≥] –ñ–¥—É –æ—Ç–≤–µ—Ç...");
        try {
            const popup = page.locator('.PopUp .content, .modal-content, .result-title, .box-content').first();
            await popup.waitFor({ state: 'visible', timeout: 15000 });
            const text = await popup.innerText();
            console.log(`[üìÑ] –†–µ–∑—É–ª—å—Ç–∞—Ç: ${text.replace(/\n/g, ' ')}`);

            if (text.match(/Busy|busy|–ø–æ–≤—Ç–æ—Ä–∏—Ç–µ/i)) result = 'CAPTCHA';
            else if (text.match(/Success|–£—Å–ø–µ—à–Ω–æ/i)) result = 'SUCCESS';
            else if (text.match(/already|–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω/i)) result = 'ALREADY_REDEEMED';
            else result = 'ERROR';

        } catch (error: any) {
             // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞–ø—á—É-–∫–∞—Ä—Ç–∏–Ω–∫—É
             if (await page.locator('#img-captcha-container').count() > 0) {
                 result = 'CAPTCHA';
             } else {
                 console.error("–û—à–∏–±–∫–∞ –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ–ø–∞–ø–∞:", error.message);
                 result = 'ERROR';
             }
        }

    } catch (error: any) {
        console.error("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", error.message);
        result = 'ERROR';
    } finally {
        await page.waitForTimeout(1000000);
    }
    return result;
}


<div class="MobileNav_sign_in__qA2oK MobileNav_imp__hchy7 MobileNav_active__Zn8O8" data-iformat="login"><i class="i-midas:user icon MobileNav_user__0id3v"></i><p>–í–æ–π—Ç–∏</p><i class="i-midas:up icon MobileNav_down__AN1h3"></i></div>
<
<
<
<        // --- 3. –ü–û–õ–£–ß–ï–ù–ò–ï –ù–ò–ö–ê ---
        const nameLocator = page.locator('div[class*="UserDataBox_text"]').first();
        if (await nameLocator.isVisible({ timeout: 5000 })) {
            username = (await nameLocator.innerText()).trim();
            console.log(`[üë§] –ò–≥—Ä–æ–∫: ${username}`);
        }

    } catch (e: any) {
        console.error(`[‚ùå] –û—à–∏–±–∫–∞: ${e.message}`);
    } finally {
        await page.waitForTimeout(60000);
        await context.close();
    }
    return username;
}
